name: Sync Files to Server Config

on:
  push:
    branches:
      - main
      - master
    # Exclude changes made by this workflow to avoid infinite loops
    paths-ignore:
      - ".github/workflows/sync-serverconfig.yml"
  workflow_dispatch: # Allow manual triggering

jobs:
  sync-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout current repository (source)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git user
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone target repository
        env:
          SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          # Clone the target repository
          git clone https://${SYNC_TOKEN}@github.com/MephistoJB/serverconfig.git /tmp/serverconfig
          cd /tmp/serverconfig
          git checkout main || git checkout master

      - name: Copy all files to target repository
        run: |
          # Create target directory if it doesn't exist
          mkdir -p /tmp/serverconfig/paperless-ngx

          # Copy all files from current repository to target
          # Exclude .git and .github directories
          rsync -av --exclude='.git' \
                    --exclude='.github' \
                    --exclude='.DS_Store' \
                    --exclude='__pycache__' \
                    --exclude='*.pyc' \
                    --exclude='venv' \
                    --exclude='.venv' \
                    --exclude='env' \
                    --exclude='.env' \
                    ${{ github.workspace }}/ /tmp/serverconfig/paperless-ngx/

          # List copied files for debugging
          echo "Copied files:"
          find /tmp/serverconfig/paperless-ngx -type f | head -20

      - name: Check for changes in target repository
        id: check-changes
        run: |
          cd /tmp/serverconfig
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi

      - name: Commit and push changes to target repository
        if: steps.check-changes.outputs.has_changes == 'true'
        env:
          SYNC_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          cd /tmp/serverconfig
          git add paperless-ngx/
          git commit -m "Sync files from ${{ github.repository }}@${{ github.sha }} [skip ci]"
          git push https://${SYNC_TOKEN}@github.com/MephistoJB/serverconfig.git main || \
          git push https://${SYNC_TOKEN}@github.com/MephistoJB/serverconfig.git master

      - name: Summary
        run: |
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "✅ Files synced successfully to MephistoJB/serverconfig"
          else
            echo "ℹ️ No changes to sync"
          fi
