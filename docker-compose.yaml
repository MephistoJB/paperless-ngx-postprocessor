
services:
  redis:
    image: docker.io/library/redis:8
    restart: unless-stopped
    volumes:
      - redisdata:/data
  paperless-ngx:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest
    restart: always
    depends_on:
      - redis
    ports:
      - "8003:8000"
      - "5678:5678"
    volumes:
      - data:/usr/src/paperless/data
      - media:/usr/src/paperless/media
      - ./:/usr/src/paperless-ngx-postprocessor
      - ./custom-cont-init.d:/custom-cont-init.d
    environment:
      PAPERLESS_POST_CONSUME_SCRIPT: /usr/src/paperless-ngx-postprocessor/post_consume_script.sh
      PNGX_POSTPROCESSOR_AI_USAGE: OLLAMA
      PNGX_POSTPROCESSOR_OLLAMA_MODEL: ministral-3
      OLLAMA_HOST: "http://192.168.1.116:11434"
      PNGX_POSTPROCESSOR_POSTPROCESSING_TAG: auto
      PNGX_POSTPROCESSOR_POSTPROCESSING_INPUT_TAG: Refresh
      PNGX_POSTPROCESSOR_AUTH_TOKEN: 736d8a5644dc562245bc0db27bc8acfb3df6a97e
      PNGX_POSTPROCESSOR_DEBUG: True
      PAPERLESS_DEBUG: True
      
      PAPERLESS_REDIS: redis://redis:6379
      PAPERLESS_ADMIN_PASSWORD: Anna1985
      #PAPERLESS_TRASH_DIR: /usr/src/paperless/media/trash
      PAPERLESS_FILENAME_FORMAT_REMOVE_NONE: True
      PAPERLESS_OCR_LANGUAGE: deu+eng
      PAPERLESS_CONSUMER_RECURSIVE: True
      PAPERLESS_CONSUMER_BARCODE_TIFF_SUPPORT: True
      PAPERLESS_CONSUMER_POLLING: 30
      PAPERLESS_TIME_ZONE: Europe/Berlin
      PAPERLESS_AUTO_LOGIN_USERNAME: admin
      PAPERLESS_FILENAME_FORMAT: "{{created}}-{{correspondent}}-{{title}}"
      PAPERLESS_NUMBER_OF_SUGGESTED_DATES: 5
      PAPERLESS_CONSUMER_BARCODE_STRING: PATCHT
      PAPERLESS_ADMIN_USER: admin
      PAPERLESS_DBENGINE: postgresql
      PAPERLESS_ENABLE_HTTP_REMOTE_USER: True
      PAPERLESS_CONSUMER_ENABLE_BARCODES: True
  paperless-gpt:
    # Use one of these image sources:
    image: icereed/paperless-gpt:latest  # Docker Hub
    ports:
      - "3001:8080"
    environment:
      PAPERLESS_BASE_URL: "http://paperless-ngx:8000"
      PAPERLESS_API_TOKEN: "736d8a5644dc562245bc0db27bc8acfb3df6a97e"
      MANUAL_TAG: "paperless-gpt" # Optional, default: paperless-gpt
      AUTO_TAG: "paperless-gpt-auto" # Optional, default: paperless-gpt-auto
      LLM_PROVIDER: "ollama"
      LLM_MODEL: "ministral-3"
      OLLAMA_HOST: "http://192.168.1.116:11434"
      TOKEN_LIMIT: 0 # Recommended for smaller models
      PDF_OCR_COMPLETE_TAG: "paperless-gpt-ocr-complete"
      OCR_LIMIT_PAGES: 0
      OCR_PROVIDER: "llm"
      AUTO_GENERATE_CREATED_DATE: true
      AUTO_GENERATE_TITLE: true
      AUTO_OCR_TAG: "paperless-gpt-ocr-auto"
      AUTO_GENERATE_TAGS: true
      AUTO_GENERATE_CORRESPONDENTS: true
      VISION_LLM_PROVIDER: "ollama"
      PDF_OCR_TAGGING: true
      LLM_LANGUAGE: "German"
      VISION_LLM_MODEL: "ministral-3"
      OCR_PROCESS_MODE: "image" #pdf / whole_pdf
      PDF_UPLOAD: "true" # Upload processed PDFs to paperless-ngx
      PDF_COPY_METADATA: "true" # Copy metadata from original to new document
      PDF_REPLACE: "false" # Whether to delete the original document (use with caution!)

    volumes:
      - gpt:/app/prompts # Mount the prompts directory
  #init_runner:
  #  image: docker:27-cli
  #  restart: "no"
  #  depends_on:
  #    - paperless-ngx
  #  volumes:
  #    - /var/run/docker.sock:/var/run/docker.sock
  #    - ./:/usr/src/paperless-ngx-postprocessor
  #  command: >
  #    sh -c "echo 'waiting for paperless to start...'; sleep 10;
  #    docker exec paperless-ngx-postprocessor-paperless-ngx-1 bash -lc '/usr/src/paperless-ngx-postprocessor/postdockerstart.sh' || true"
  #   extra_hosts:
  #    - "host.docker.internal:host-gateway"
  #  environment:
  #    - DOCKER_HOST=unix:///var/run/docker.sock
volumes:
  data:
  media:
  redisdata:
  gpt: